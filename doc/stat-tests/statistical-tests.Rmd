---
title: "Goodness of fit tests"
author: "Michele Nguyen, Maricar Rabonza"
date: "2022"
output:
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(goftest)
library(gridExtra)
library(moments)
library(LaplacesDemon)
library(here)
```

## Overview

Here we demonstrate the following goodness-of-fit tests using sample results from tephra inversion modelling.

- Kolmogorov-Smirnov (K-S) test
- Cram'er-von Mises (CvM) test
- Anderson-Darling (AD) test
- Shapiro-Wilk test (for Gaussian distributions only)
- Skewness

Each loss function is associated with distributional assumptions on the residuals, hence we can check the appropriateness of the choice of loss function based on the goodness-of-fit of the residuals to these assumed distributions.

## Load sample residuals

For this code, we need sample results from different cost functions. Here we utilise results from the following:

- Mean square error (MSE)
- Chi-square error
- Mean square logarithmic error (MSLE)
- Mean absolute error (MAE)
- Mean absolute percentage error (MAPE)

The sample results are generated from multiple inversions, each using a different cost function. Using the best-fit parameters, we predict the tephra load at the observation sites. The results from each inversion are saved in separate tables.

The tables consist of three columns:

- `Observation`: Value of observed data 
- `Prediction`: Value of modelled output
- `Residual`: Calculated as Observation - Prediction

```{r}
mse <- read.csv("sample_results-mse.csv") # table for Mean square error (MSE)
chi <- read.csv("sample_results-chisquare.csv") # table for Chi-square error
msl <- read.csv("sample_results-msl.csv") # table for Mean square logarithmic error (MSLE)
mae <- read.csv("sample_results-mae.csv") # table for Mean absolute error (MAE)
map <- read.csv("sample_results-map.csv") # table for Mean absolute percentage error (MAPE)
```

```{r}
head(mse) # first few rows of table
head(chi) # first few rows of table
head(mae) # first few rows of table
head(msl) # first few rows of table
head(map) # first few rows of table
```
## Statistical tests for inversion results

We conduct the statistical tests on the residuals. Typically these assume iid residuals.

### For MSE

```{r}
# Standardise residuals
mse$SResidual <- mse$Residual/sd(mse$Residual)
# K-S test:
mse_ks <- ks.test(x = mse$SResidual, y = pnorm)
# Anderson-Darling test:
mse_ad <- ad.test(x = mse$SResidual, null = "pnorm")
# CvM test:
mse_cvm <- cvm.test(mse$SResidual, null = "pnorm")
# Shapiro test:
mse_shapiro <- shapiro.test(mse$SResidual)
# Skewness
mse_skew <- skewness(mse$Residual) 
```

```{r}
mse_qq <- ggplot(data = mse, aes(sample = SResidual)) + 
  stat_qq() + 
  geom_abline(slope = 1, intercept = 0) + 
  coord_equal(x = c(-4, 4), y = c(-4, 4)) + 
  labs(title="(A) MSE", x = "From model fit", y = "Theoretical quantiles")+
  theme_classic() + 
  theme(plot.title=element_text(face="bold"))
```

### For Chi-square

```{r}
# Standardise residuals
chi$SResidual <- chi$Residual/sqrt(chi$Observation) # Divide by square-root of Actual:
# K-S test:
chi_ks <- ks.test(x = chi$SResidual, y = pnorm)
# Anderson-Darling test:
chi_ad <- ad.test(x = chi$SResidual, null = "pnorm")
# CvM test:
chi_cvm <- cvm.test(chi$SResidual, null = "pnorm")
# Shapiro test:
chi_shapiro <- shapiro.test(chi$SResidual)
# Skewness
chi_skew <- skewness(chi$Residual) 
```

```{r}
chi_qq <- ggplot(data = chi, aes(sample = SResidual)) + 
  stat_qq() + 
  geom_abline(slope = 1, intercept = 0) + 
  coord_equal(x = c(-4, 4), y = c(-4, 4)) + 
  ggtitle("(B) Chi-square") + 
    labs(x = "From model fit", y = "Theoretical quantiles")+
  theme_classic() + 
  theme(plot.title=element_text(face="bold"))

```

### For MSLE

```{r}
# Standardise residuals
msl$SResidual <- log10(msl$Prediction + 1) - log10(msl$Observation + 1) # Compute according to formula:
msl_sresid_sd <- sd(msl$SResidual) 
msl$SResidual <- msl$SResidual/msl_sresid_sd # Standardise by sd to get N(0,1):
# K-S test:
msl_ks <- ks.test(x = msl$SResidual, y = pnorm)
# Anderson-Darling test:
msl_ad <- ad.test(x = msl$SResidual, null = "pnorm")
# CvM test:
msl_cvm <- cvm.test(msl$SResidual, null = "pnorm")
# Shapiro test:
msl_shapiro <- shapiro.test(msl$SResidual)
# Skewness
msl_skew <- skewness(msl$Residual) 
```

```{r}
msl_qq <- ggplot(data = msl, aes(sample = SResidual)) + 
  stat_qq() + 
  geom_abline(slope = 1, intercept = 0) + 
  theme_classic() + 
  coord_equal(x = c(-4, 4), y = c(-4, 4)) + 
  ggtitle("(C) MSLE") + labs(x = "From model fit", y = "Theoretical quantiles")+
  theme(plot.title=element_text(face="bold"))
```

### For MAE

```{r}
# Standardise residuals
# 1. Compute according to formula:
mae_scale <- mean(abs(mae$Residual - median(mae$Residual)))
#MLE estimator of scale = mean absolute deviation. (Fix mean to be 0.)

# 2. Standardise by scale to get Laplace(0, 1):
mae$SResidual <- mae$Residual/mae_scale

# K-S test:
mae_ks <- ks.test(x = mae$SResidual, y = plaplace)
# Anderson-Darling test:
mae_ad <- ad.test(x = mae$SResidual, null = "plaplace")
# CvM test:
mae_cvm <- cvm.test(mae$SResidual, null = "plaplace")
# Shapiro test:
mae_shapiro <- NA
mae_skew <- skewness(mae$Residual) 
```

```{r}
mae_qq <- ggplot(data = mae, aes(sample = SResidual)) + 
  stat_qq(distribution = qlaplace) + 
  geom_abline(slope = 1, intercept = 0) + 
  theme_classic() + 
  coord_equal(x = c(-7, 7), y = c(-7, 7)) + 
  ggtitle("(A) MAE") + labs(x = "From model fit", y = "Theoretical quantiles")+
  theme(plot.title=element_text(face="bold"))
```

### For MAPE

```{r}
# Standardise residuals
# 1. Compute according to formula:
map$SResidual <- map$Residual/map$Observation
map_sresid_scale <- mean(abs(map$SResidual- median(mae$SResidual))) 
#MLE estimator of scale = mean absolute deviation. (Fix mean to be 0.)

# 2. Standardise by scale to get Laplace(0, 1):
map$SResidual <- map$SResidual/map_sresid_scale

# K-S test:
map_ks <- ks.test(x = map$SResidual, y = plaplace)
# Anderson-Darling test:
map_ad <- ad.test(x = map$SResidual, null = "plaplace")
# CvM test:
map_cvm <- cvm.test(map$SResidual, null = "plaplace")
# Shapiro test:
map_shapiro <- NA
map_skew <- skewness(map$Residual) 
```

```{r}
map_qq <- ggplot(data = map, aes(sample = SResidual)) + 
 stat_qq(distribution = qlaplace) + 
 geom_abline(slope = 1, intercept = 0) + theme_classic() + 
 coord_equal(x = c(-7, 7), y = c(-7, 7)) + 
 ggtitle("(B) MAPE") + labs(x = "From model fit", y = "Theoretical quantiles")+
 theme(plot.title=element_text(face="bold"))
```


## Compare cost functions

```{r}

temp_df <- data.frame("Loss function" = c("MSE", "Chi-squared", "MSLE",
                                          "MAE", "MAPE"), 
                      "K-S" = round(c(mse_ks$statistic, chi_ks$statistic, 
                                      msl_ks$statistic, mae_ks$statistic,
                                      map_ks$statistic), digits = 3),
                       "K-S p-value" = round(c(mse_ks$p.value, chi_ks$p.value, 
                                               msl_ks$p.value, mae_ks$p.value,
                                               map_ks$p.value), digits = 3),
                        "CvM" = round(c(mse_cvm$statistic, chi_cvm$statistic, 
                                        msl_cvm$statistic, mae_cvm$statistic,
                                        map_cvm$statistic), digits = 3),
                        "CvM p-value" = round(c(mse_cvm$p.value, chi_cvm$p.value, 
                                                msl_cvm$p.value, mae_cvm$p.value,
                                                map_cvm$p.value), digits = 3),
                        "AD" = round(c(mse_ad$statistic, chi_ad$statistic, 
                                       msl_ad$statistic, mae_ad$statistic,
                                       map_ad$statistic), digits = 3),
                        "AD p-value" = round(c(mse_ad$p.value, chi_ad$p.value, 
                                               msl_ad$p.value, mae_ad$p.value,
                                               map_ad$p.value), digits = 3),
                        "Shapiro-Wilk" = round(c(mse_shapiro$statistic, 
                                                 chi_shapiro$statistic, 
                                                 msl_shapiro$statistic,
                                                 mae_shapiro,
                                                 map_shapiro), 
                                               digits = 3),
                        "Shapiro-Wilk p-value" = round(c(mse_shapiro$p.value, 
                                                         chi_shapiro$p.value, 
                                                         msl_shapiro$p.value,
                                                         mae_shapiro,
                                                         map_shapiro
                                                         ),
                                                       digits = 3),
                        "Skewness" = round(c(mse_skew, chi_skew, msl_skew,
                                             mae_skew, map_skew),
                                                       digits = 3)
                         )

knitr::kable(temp_df, caption = "Goodness-of-fit test statistics and p-values for the model residuals according to the loss functions used to fit them. The estimated skewness of the raw residuals (Predicted - Actual) are also shown. For all stests, the null hypothesis is that the residuals follow the distribution assumed by the choice of the loss function. So large p-values indicate better fit and adherence to the assumptions.")

```

The skewness estimates are not a good reflection of the tendency for symmetrric loss functions to overpredict rather than underpredict (since the load values themselves cannot physically go below zero). Instead, we visualise this using density plots of the raw residuals (Predicted - Actual) against Actual.

```{r}

den_mse <- density(mse$Residual, from = -60, to = 60, n = 512)
# plot(den_mse$x, den_mse$y)
den_chi <- density(chi$Residual, from = -60, to = 60, n = 512)
den_msl  <- density(msl$Residual, from = -60, to = 60, n = 512)

den_mae  <- density(mae$Residual, from = -60, to = 60, n = 512)
den_map  <- density(map$Residual, from = -60, to = 60, n = 512)

den_df <- data.frame("Residual" = rep(den_mse$x, 5), 
                     "Density" = c(den_mse$y, den_chi$y, den_msl$y, den_mae$y, den_map$y),
                     "Loss" = rep(c("MSE", "Chi-squared", "MSLE", "MAE", "MAPE"), each = length(den_mse$x)))

```

```{r}
den_compare<- ggplot() + geom_line(data = den_df, aes(x = Residual, y = Density, color = Loss)) + 
  theme_classic() + ggtitle("Density of raw residuals") + coord_cartesian(xlim = c(-20, 20)) +
  geom_vline(xintercept = 0, lty = 2)

den_compare

```

```{r}
# Residual vs load by color:
rvsl_df <- data.frame("Residual" = c(mse$Residual, chi$Residual, msl$Residual,
                                     mae$Residual, map$Residual),
                      "Observation" = c(mse$Observation, chi$Observation, msl$Observation,
                                     mae$Observation, map$Observation),
                     "Loss" = rep(c("MSE", "Chi-squared", "MSLE", "MAE", "MAPE"), each = nrow(mse)))

```

```{r}
rvsl_compare <- ggplot() + geom_point(data = rvsl_df, aes(x = Residual, y = Observation, color = Loss)) + 
  theme_classic() + ggtitle("Raw residuals against load") 
rvsl_compare

```


```{r, fig.height=3.5, fig.width=10.5}

rvsl_mse <- ggplot() + 
  geom_point(data = mse, aes(x = Residual, y = Observation)) + 
  coord_fixed(xlim = c(-100,100), ylim = c(0, 175)) + 
  theme_classic() + 
  ggtitle("MSE") + 
  geom_abline(intercept = 25, slope = 0, lty = 2) + 
  geom_hline(yintercept = 25, lty = 2) + 
  geom_vline(xintercept = 25, lty = 2)

rvsl_chi <- ggplot() + 
  geom_point(data = chi, aes(x = Residual, y = Observation))  + 
  coord_fixed(xlim = c(-100,100), ylim = c(0, 175)) + 
  theme_classic() + 
  ggtitle("Chi-squared") + 
  geom_hline(yintercept = 25, lty = 2) + 
  geom_vline(xintercept = 25, lty = 2)

rvsl_msl <- ggplot() + 
  geom_point(data = msl, aes(x = Residual, y = Observation))  + 
  coord_fixed(xlim = c(-100,100), ylim = c(0, 175)) + 
  theme_classic() + ggtitle("MSLE") + 
  geom_hline(yintercept = 25, lty = 2) + 
  geom_vline(xintercept = 25, lty = 2)

grid.arrange(rvsl_mse, rvsl_chi, rvsl_msl, nrow = 1, ncol = 3)

```

```{r, fig.height=3.5, fig.width=7}

rvsl_mae <- ggplot() + 
  geom_point(data = mae, aes(x = Residual, y = Observation)) + 
  coord_fixed(xlim = c(-100,100), ylim = c(0, 175)) + 
  theme_classic() + 
  ggtitle("MAE") + 
  geom_abline(intercept = 25, slope = 0, lty = 2) + 
  geom_hline(yintercept = 25, lty = 2) + 
  geom_vline(xintercept = 25, lty = 2)

rvsl_mape <- ggplot() + 
  geom_point(data = map, aes(x = Residual, y = Observation))  + 
  coord_fixed(xlim = c(-100,100), ylim = c(0, 175)) + 
  theme_classic() + 
  ggtitle("MAPE") + 
  geom_hline(yintercept = 25, lty = 2) + 
  geom_vline(xintercept = 25, lty = 2)

grid.arrange(rvsl_mae, rvsl_mape, nrow = 1, ncol = 2)

```

```{r, fig.height=3.5, fig.width=10.5}

qq1 <- grid.arrange(mse_qq, chi_qq, msl_qq,
             nrow = 1, ncol = 3)

ggsave(qq1, file= "qq1.png",
       #width = 7, height = 3.5,
       scale =1,
       dpi = 300)

```

```{r, fig.height=3.5, fig.width=7}

qq2 <- grid.arrange(mae_qq, map_qq, nrow = 1, ncol = 2)

ggsave(qq2, file= "qq2.png",
       #width = 7, height = 3.5,
       scale =1,
       dpi = 300)

```